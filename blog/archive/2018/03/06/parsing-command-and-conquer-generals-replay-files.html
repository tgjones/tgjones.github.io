<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>Parsing Command & Conquer: Generals replay files - timjones.io</title>

    <meta name="description" content="Blog and open source projects by Tim Jones.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="alternate" href="http://timjones.io/feed.xml" type="application/atom+xml" title="timjones.io Feed">

    <link href="https://fonts.googleapis.com/css?family=Noto+Sans|Noto+Serif|Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/site.css">

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true
            },
            showProcessingMessages: false
        });
    </script>
    <script type="text/javascript" async src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML.js"></script>
</head>

<body>
    <header class="masthead">
        <div class="container">
            <nav>
                <ul>
                    <li>
                        <h3><a href="/" class="site-title">Tim Jones</a></h3>
                    </li>
                    <li><a href="/projects/">Projects</a></li>
                    <li><a href="/about/">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <main>
            <article>
    <h1 class="post-title">Parsing Command & Conquer: Generals replay files</h1>

    <div class="post-date">
        <time datetime="2018-03-06T12:00:00+00:00">06 March 2018</time>
    </div>

    
    <div class="post-tags">
        <ul>
            
            <li><a href="/blog/tags/opensage">OpenSAGE</a></li>
            
        </ul>
    </div>
    

    <p><strong>TL/DR: In this post we’ll examine C&amp;C Generals replay (.rep) files in detail, figure out how they work, and then look at a very early implementation of a replay viewer that I’ve added to <a href="https://github.com/OpenSAGE/OpenSAGE">OpenSAGE</a>.</strong></p>

<p>Have you ever saved a replay from [insert your favourite video game here], and wondered exactly what the replay file contains? I don’t know how many people will answer “yes” to that question, but I’m one of them. For efficiency and IP-protection reasons, replay files are usually stored in a binary format, so if you open one of them in Notepad, all you’ll see are a bunch of garbled characters. It’s often a long road from there, to fully understanding and being able to parse one of these files.</p>

<p>One of the features I hope to support in <a href="https://github.com/OpenSAGE/OpenSAGE">OpenSAGE</a> is being able to use replay files from the original Command &amp; Conquer: Generals and Zero Hour games. Since no official description of Generals’ replay file format has been published, I have to do it the hard way, and figure out the file format… but fortunately, I’m not the first to want to do this.</p>

<p>I should note here that replay files vary wildly between games, so what applies to one specific RTS game won’t apply directly to other games, but the general principles should be similar, at least across RTS games.</p>

<p>Before we get into the details, let’s start with the fun part: creating a replay file in the first place.</p>

<h2 id="creating-a-replay-file">Creating a replay file</h2>

<p>Let’s load C&amp;C Generals, and play a quick skirmish game. For the purposes of this blog post, I want to keep the replay file <em>really</em> simple, so all I’ll do is start a single-player skirmish game, build one building, and exit. Here’s what that looks like:</p>

<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/Nv0NdiYz1fA" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>
</div>

<p>Here’s the replay file that Generals saved for that game:</p>

<ul>
  <li><a href="/assets/posts/simple-generals-replay.rep">simple-generals-replay.rep</a></li>
</ul>

<h2 id="first-look">First look</h2>

<p>If we open that replay file in VSCode using the excellent <a href="https://marketplace.visualstudio.com/items?itemName=slevesque.vscode-hexdump">hexdump</a> extension, we’ll see this:</p>

<p><img src="/assets/resized/generals-replay-hex-800x795.png" alt="Hex view of C&amp;C Generals replay file" srcset="/assets/resized/generals-replay-hex-400x398.png 400w,/assets/resized/generals-replay-hex-800x795.png 800w" /></p>

<p>You can immediately see some human-readable text there. That’s always nice to see, when you’re parsing an unknown binary format.</p>

<p>It was at this point, when I first looked at Generals’ replay files, that I wondered whether anybody else had figured out the file format before. So I Googled and found <a href="https://github.com/louisdx/cnc-replayreaders">the cnc-replayreaders repo on GitHub</a>, which contains at least <em>some</em> work on parsing replay files for many SAGE games, including, happily, C&amp;C Generals. Without this information, proceeding further would have been much harder. <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/ccgzhreader.cpp">Here’s the C++ code for a prototype version of a Generals replay parser</a>. There’s even a <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/eareplay.html">document with the beginnings of a spec for these replay files</a>. This is great stuff! Many thanks to <a href="https://github.com/louisdx">louisdx</a>, who I believe also goes by the name <a href="https://www.gamereplays.org/community/index.php?s=82acbb27d5c639b8dc4210422352778b&amp;showuser=122871">R Schneider on gamereplays.org</a>. I’ll duplicate the Generals part of it here:</p>

<blockquote>
  <h3 id="generals-zero-hour-battle-for-middle-earth-rise-of-the-witch-king">Generals, Zero Hour, Battle for Middle Earth, Rise of the Witch King</h3>
  <p>The replay format of the games <em>Generals</em>, <em>Zero Hour</em>, <em>Battle for Middle Earth</em>, <em>Battle for Middle Earth 2</em>, and its expansion <em>Rise of the Witch King</em> is considerably simpler than that of the later games. Most notably, the chunks do not have length information, so one must know their sizes by other means. Also, there is no footer, just a final chunk.</p>
  <h4 id="header">Header</h4>
  <p>The size <code class="highlighter-rouge">u1</code> is 12 for <em>Generals</em> and <em>Zero Hour</em>, and 21 in the BfME games; <code class="highlighter-rouge">u2</code> is 8 in CCG/ZH and 13 in the BfME games; <code class="highlighter-rouge">u3</code> is 4 except in BfME2, where it is 6.</p>
  <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">char</span>             <span class="n">str_magic</span><span class="p">[</span><span class="mi">6</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>     <span class="c1">// == "GENREP", "BFMEREPL" or "BFME2RPL"
</span><span class="kt">uint32_t</span>         <span class="n">timestamp_begin</span><span class="p">;</span>
<span class="kt">uint32_t</span>         <span class="n">timestamp_end</span><span class="p">;</span>
<span class="n">byte</span>             <span class="n">unknown1</span><span class="p">[</span><span class="n">u1</span><span class="p">];</span>
<span class="n">tb_str</span>           <span class="n">str_filename</span><span class="p">;</span>
<span class="n">tb_ch</span>            <span class="n">date_time</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>       <span class="c1">// as in TW/KW
</span><span class="n">tb_str</span>           <span class="n">str_version</span><span class="p">;</span>
<span class="n">tb_str</span>           <span class="n">str_build_date</span><span class="p">;</span>
<span class="kt">uint16_t</span>         <span class="n">version_minor</span><span class="p">;</span>
<span class="kt">uint16_t</span>         <span class="n">version_major</span><span class="p">;</span>
<span class="n">byte</span>             <span class="n">magic_hash</span><span class="p">[</span><span class="n">u2</span><span class="p">]</span>
<span class="kt">char</span>             <span class="n">header</span><span class="p">[];</span>           <span class="c1">// null-terminated!
</span><span class="kt">uint16_t</span>         <span class="n">unknown2</span><span class="p">;</span>
<span class="kt">uint32_t</span>         <span class="n">unkonwn3</span><span class="p">[</span><span class="n">u3</span><span class="p">];</span>
</code></pre>
  </div>
  <p><strong>Remarks.</strong> The two timestamps appear to indicate the real-world start and end time of the game. The <code class="highlighter-rouge">header</code> is of the same format as the later games.</p>
  <h4 id="the-replay-body">The replay body</h4>
  <p>The replay body consists of a sequence of <em>chunks</em>. Each chunk is of the following form:</p>
  <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">uint32_t</span>         <span class="n">time_code</span><span class="p">;</span>
<span class="kt">uint32_t</span>         <span class="n">chunk_code</span><span class="p">;</span>
<span class="kt">uint32_t</span>         <span class="n">number</span><span class="p">;</span>         <span class="c1">// Player number?
</span><span class="n">byte</span>             <span class="n">number_of_commands</span><span class="p">;</span>
<span class="k">struct</span> <span class="p">{</span> <span class="n">byte</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">byte</span> <span class="n">nargs</span> <span class="p">}</span> <span class="n">signature</span><span class="p">[</span><span class="n">number_of_commands</span><span class="p">];</span>
<span class="n">byte</span>             <span class="n">arguments</span><span class="p">[];</span>    <span class="c1">// variable!
</span></code></pre>
  </div>
  <p>In the simplest case, <code class="highlighter-rouge">number_of_commands</code> is zero and <code class="highlighter-rouge">signature</code> and <code class="highlighter-rouge">arguments</code> are empty. Otherwise, there are <code class="highlighter-rouge">number_of_commands</code> many pairs of bytes {<code class="highlighter-rouge">cmd</code>,<code class="highlighter-rouge">nargs</code>}, where <code class="highlighter-rouge">cmd</code> refers to one of about ten commands and <code class="highlighter-rouge">nargs</code> is the number of arguments. The size of an argument depends on the command type. Finally, <code class="highlighter-rouge">arguments</code>  consists of all the arguments of all the commands, simply one after the other.
The meaning of the chunk codes is unknown in general. Only a handful of values seem to occur, all in the range 0x300 - 0x500, and 0x1B, 0x1D. Many codes only ever seem to appear with a fixed, specific signature of commands.
These are the known commands and their argument sizes.</p>

  <table>
    <thead>
      <tr>
        <th>command</th>
        <th>argument size (bytes)</th>
        <th>Description/Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>0x00</td>
        <td>4</td>
        <td>?</td>
      </tr>
      <tr>
        <td>0x01</td>
        <td>4</td>
        <td>?</td>
      </tr>
      <tr>
        <td>0x02</td>
        <td>1</td>
        <td>?</td>
      </tr>
      <tr>
        <td>0x03</td>
        <td>4</td>
        <td>?</td>
      </tr>
      <tr>
        <td>0x04</td>
        <td>4</td>
        <td>?</td>
      </tr>
      <tr>
        <td>0x06</td>
        <td>12</td>
        <td>3 uint32_t’s? 1 long double?</td>
      </tr>
      <tr>
        <td>0x07</td>
        <td>12</td>
        <td>3 uint32_t’s? 1 long double?</td>
      </tr>
      <tr>
        <td>0x08</td>
        <td>16</td>
        <td>4 uint32_t’s?</td>
      </tr>
      <tr>
        <td>0x09</td>
        <td>4/16</td>
        <td>4 bytes in BFME2, 16 otherwise</td>
      </tr>
      <tr>
        <td>0x0A</td>
        <td>4</td>
        <td>4 uint32_t’s?</td>
      </tr>
    </tbody>
  </table>

  <p>There is no footer. The final chunk has <code class="highlighter-rouge">number_of_commands</code> set to zero, and it appears to have command code 0x1B or 0x1D.</p>
</blockquote>

<h2 id="parsing-the-header">Parsing the header</h2>

<p>Armed with that information, let’s get started with parsing the header. I’ll use C# here, because that’s what we’re using in the <a href="https://github.com/OpenSAGE/OpenSAGE/tree/master/src/OpenSage.Game/Data/Rep">OpenSAGE</a> project, but really any language that gives you the ability to read from a byte stream will work.</p>

<p>Before we can parse anything, we need to open a <code class="highlighter-rouge">BinaryReader</code> for the replay file:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="s">"simple-generals-replay.rep"</span><span class="p">))</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryReader</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// TODO: Parse header
</span>    <span class="c1">// TODO: Parse body
</span><span class="p">}</span>
</code></pre>
</div>

<p>Now we can parse the header, based on the description above. I’ve commented most lines with the actual values from our sample replay file.</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="kt">string</span> <span class="n">magic</span><span class="p">;</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">asciiReader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryReader</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">magic</span> <span class="p">=</span> <span class="n">asciiReader</span><span class="p">.</span><span class="nf">ReadFixedLengthString</span><span class="p">(</span><span class="m">6</span><span class="p">);</span> <span class="c1">// "GENREP"
</span><span class="p">}</span>

<span class="kt">var</span> <span class="n">origin</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1970</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DateTimeKind</span><span class="p">.</span><span class="n">Utc</span><span class="p">);</span>
<span class="n">DateTime</span> <span class="nf">readTimestamp</span><span class="p">(</span><span class="n">BinaryReader</span> <span class="n">reader</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">origin</span><span class="p">.</span><span class="nf">AddSeconds</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">());</span>

<span class="kt">var</span> <span class="n">timestampBegin</span> <span class="p">=</span> <span class="nf">ReadTimestamp</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span> <span class="c1">// "2018-03-05 1:28:17 UTC"
</span><span class="kt">var</span> <span class="n">timestampEnd</span> <span class="p">=</span> <span class="nf">ReadTimestamp</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>   <span class="c1">// "2018-03-05 1:28:42 UTC"
</span>
<span class="kt">var</span> <span class="n">numTimecodes</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt16</span><span class="p">();</span> <span class="c1">// "577"
</span>
<span class="kt">var</span> <span class="n">unknown1</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">12</span><span class="p">);</span> <span class="c1">// Sometimes all zeros, and sometimes not
</span>
<span class="kt">var</span> <span class="n">filename</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadNullTerminatedString</span><span class="p">();</span> <span class="c1">// "Last Replay"
</span>
<span class="kt">var</span> <span class="n">dateTime</span> <span class="p">=</span> <span class="n">ReplayTimestamp</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span> <span class="c1">// "2018-03-05 21:28:17.402 Monday"
</span>
<span class="kt">var</span> <span class="n">version</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadNullTerminatedString</span><span class="p">();</span> <span class="c1">// "Version 1.7"
</span><span class="kt">var</span> <span class="n">buildDate</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadNullTerminatedString</span><span class="p">();</span> <span class="c1">// "Sep  6 2012 09:43:29"
</span>
<span class="kt">var</span> <span class="n">versionMinor</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt16</span><span class="p">();</span> <span class="c1">// 7
</span><span class="kt">var</span> <span class="n">versionMajor</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt16</span><span class="p">();</span> <span class="c1">// 1
</span>
<span class="kt">var</span> <span class="n">magicHash</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">8</span><span class="p">);</span> <span class="c1">// 236, 122, 38, 27, 251, 102, 39, 119
</span>
<span class="kt">var</span> <span class="n">metadata</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadNullTerminatedAsciiString</span><span class="p">();</span> <span class="c1">// "M=07maps/desert fury;MC=83506418;MS=214497;SD=625705968;C=100;S=HDESKTOP-9V9469L,0,0,TT,-1,2,-1,-1,1:CH,-1,-1,-1,-1:X:X:X:X:X:X:;"
</span>
<span class="kt">var</span> <span class="n">unknown2</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt16</span><span class="p">();</span> <span class="c1">// "48"
</span>
<span class="kt">var</span> <span class="n">unknown3</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// "1"
</span><span class="kt">var</span> <span class="n">unknown4</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// "2"
</span><span class="kt">var</span> <span class="n">unknown5</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// "0"
</span>
<span class="kt">var</span> <span class="n">gameSpeed</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// "30"
</span></code></pre>
</div>

<p>So, the header spec in the <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/eareplay.html">cnc-replayreaders project</a> looks pretty accurate. I’ve worked out that one of the unknowns is the game speed. I don’t know about the others, but by comparing enough replays with known game states, it should be possible to work them out.</p>

<p>This already gives us quite a lot of interesting data, such as the map, player details, start and end times, and even the date that the version of Generals that I’m using was compiled (September 6th 2012, apparently).</p>

<p>This is all very well, but what I’m really interested in is the actual replay data.</p>

<h2 id="parsing-the-body">Parsing the body</h2>

<p>There are many ways game replay data can be saved. If there aren’t too many “things” in the world to keep track of, you could store the entire state of the world at every timestep. For RTS games with potentially hundreds or thousands of units, this wouldn’t scale - and so these games usually only save player inputs, and use those inputs to recreate the entire simulation. (This is also why you often can’t rewind replays; you’d have to start from the beginning again, and simulate every frame up to the one you’re interested in, in order to get the correct state for that frame.)</p>

<p>Knowing that, what I’m expecting to see in the body of the replay file is a sequence of commands (or “orders”, as I’ve chosen to call them), roughly corresponding to the actions I performed in the game. For example, “select unit” and “create power plant”. Each of those orders would have arguments relevant to the order type. For example, “select unit” would have some sort of identifier to store which unit was selected.</p>

<p>There may be (and in fact, are) some orders that weren’t triggered by me, such as an “end game” order - anything that the game can’t recreate by itself needs to be saved in the replay file.</p>

<p>Fortunately for us, the cnc-replayreaders spec appears to match this concept, so we’re on the right track. It looks like a “chunk” is probably a single order, and every order has 0 or more arguments.</p>

<p>The body of a replay file is composed of <code class="highlighter-rouge">n</code> chunks. There’s no way to know how many chunks there are from the header - after reading the header, you just have to keep reading chunks until you get to the end of the file. Like this:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">BaseStream</span><span class="p">.</span><span class="n">Position</span> <span class="p">&lt;</span> <span class="n">reader</span><span class="p">.</span><span class="n">BaseStream</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// TODO: Parse chunk
</span><span class="p">}</span>
</code></pre>
</div>

<p>Let’s look at the basic structure of a chunk. Then we can impose that structure onto our sample replay file and see what we get.</p>

<p>Let’s use the description quoted above, and convert it into the code to parse a chunk header:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="kt">var</span> <span class="n">timecode</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// 0-based timecode
</span><span class="kt">var</span> <span class="n">orderType</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">ReadUInt32AsEnum</span><span class="p">&lt;</span><span class="n">OrderType</span><span class="p">&gt;();</span> <span class="c1">// See below
</span><span class="kt">var</span> <span class="n">number</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span> <span class="c1">// 0-based index of this chunk
</span>
<span class="kt">var</span> <span class="n">numUniqueArgumentTypes</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">();</span> <span class="c1">// Number of unique argument types
</span>
<span class="c1">// Pairs of {argument type, count}.
</span><span class="kt">var</span> <span class="n">argumentCounts</span> <span class="p">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">OrderArgumentType</span> <span class="n">argumentType</span><span class="p">,</span> <span class="kt">byte</span> <span class="n">count</span><span class="p">)[</span><span class="n">numUniqueArgumentTypes</span><span class="p">];</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numUniqueArgumentTypes</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="c1">// Read the number of arguments for this argument type.
</span>    <span class="n">argumentCounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">ReadByteAsEnum</span><span class="p">&lt;</span><span class="n">OrderArgumentType</span><span class="p">&gt;(),</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// TODO: Read argument data
</span></code></pre>
</div>

<p>We don’t know what <code class="highlighter-rouge">orderType</code> means yet; we’ll have to look at the chunks, once we’ve parsed them, and make some guesses. We’ll do that below.</p>

<p><code class="highlighter-rouge">argumentCounts</code> stores the number of arguments <em>for each argument type</em>. So there might be 2 integer arguments, 1 boolean argument, and 1 float argument, for example. We can calculate the total number of arguments by summing the counts of each argument type.</p>

<p>Our first order of business is working out how many bytes each argument value uses, because without knowing that, we don’t know where the next chunk starts.</p>

<p>There’s nothing in the chunk header that directly tells us how big the argument data array is. We need to derive it from the number and type of arguments. I worked out the argument types from looking at a few replay files in a hex viewer and making some educated guesses. This fills in the gaps in the table of commands that I quoted above. Here’s what I’ve found so far, although I’m sure there are more:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">enum</span> <span class="n">OrderArgumentType</span> <span class="p">:</span> <span class="kt">byte</span>
<span class="p">{</span>
    <span class="n">Integer</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>       <span class="c1">// int32 (4 bytes)
</span>    <span class="n">Float</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>         <span class="c1">// float32 (4 bytes)
</span>    <span class="n">Boolean</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span>       <span class="c1">// bool (1 byte)
</span>    <span class="n">ObjectId</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span>      <span class="c1">// uint32 (4 bytes)
</span>    <span class="n">Position</span> <span class="p">=</span> <span class="m">6</span><span class="p">,</span>      <span class="c1">// float32 * 3 (12 bytes)
</span>    <span class="n">ScreenPosition</span> <span class="p">=</span> <span class="m">7</span> <span class="c1">// int32 * 2 (8 bytes)
</span><span class="p">}</span>
</code></pre>
</div>

<p>Now we can write the code to parse order arguments. Note that, to keep things simple, I’m not doing anything with the parsed variables, but <a href="https://github.com/OpenSAGE/OpenSAGE/blob/6887852b18b51c08359b7cc03634a4e02218741f/src/OpenSage.Game/Data/Rep/ReplayChunk.cs#L37">in the real code</a> I do.</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numUniqueArgumentTypes</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
<span class="p">{</span>
    <span class="k">ref</span> <span class="kt">var</span> <span class="n">argumentCount</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">argumentCounts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">var</span> <span class="n">argumentType</span> <span class="p">=</span> <span class="n">argumentCount</span><span class="p">.</span><span class="n">argumentType</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">argumentCount</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">argumentType</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">Integer</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadInt32</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">Float</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">f</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadSingle</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">Boolean</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">b</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBooleanChecked</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">ObjectId</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">oi</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadUInt32</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">Position</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadVector3</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="n">OrderArgumentType</span><span class="p">.</span><span class="n">ScreenPosition</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">sp</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadPoint2D</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">default</span><span class="p">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Armed with all that code, we can finally parse our sample replay file. Let’s do that, and write out all the replay chunks from our sample replay file. I’ve trimmed it down, because the replay file contains 733 lines - i.e. 733 orders - most of which are duplicate <code class="highlighter-rouge">1092</code> orders. I’ve marked the trimmed lines with “…”.</p>

<table>
  <thead>
    <tr>
      <th>Timecode</th>
      <th>OrderType</th>
      <th>Number</th>
      <th>Arg 1</th>
      <th>Arg 2</th>
      <th>Arg 3</th>
      <th>Arg 4</th>
      <th>Arg 5</th>
      <th>Arg 6</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1092</td>
      <td>0</td>
      <td>Position:&lt;0, 0, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.490186</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;0, 0&gt;</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1095</td>
      <td>2</td>
      <td>Integer:431591478</td>
      <td>Boolean:False</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>1</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;174, 521&gt;</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:16</td>
      <td>ScreenPosition:&lt;174, 521&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>96</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 322&gt;</td>
    </tr>
    <tr>
      <td>97</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>98</td>
      <td>1003</td>
      <td>2</td>
      <td>Boolean:True</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>98</td>
      <td>1001</td>
      <td>2</td>
      <td>Boolean:True</td>
      <td>ObjectId:469</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>98</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>99</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>100</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>101</td>
      <td>1095</td>
      <td>2</td>
      <td>Integer:1160876625</td>
      <td>Boolean:False</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>101</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>102</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;470, 324&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>199</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 292&gt;</td>
    </tr>
    <tr>
      <td>200</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 292&gt;</td>
    </tr>
    <tr>
      <td>201</td>
      <td>1095</td>
      <td>2</td>
      <td>Integer:-1950611085</td>
      <td>Boolean:False</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>201</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 292&gt;</td>
    </tr>
    <tr>
      <td>202</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 292&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>214</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 294&gt;</td>
    </tr>
    <tr>
      <td>215</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:10</td>
      <td>ScreenPosition:&lt;600, 294&gt;</td>
    </tr>
    <tr>
      <td>216</td>
      <td>1049</td>
      <td>2</td>
      <td>Integer:774</td>
      <td>Position:&lt;553.6661, 1923.072, 140&gt;</td>
      <td>Float:-0.7853982</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>216</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;600, 294&gt;</td>
    </tr>
    <tr>
      <td>217</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;600, 294&gt;</td>
    </tr>
    <tr>
      <td>218</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;600, 294&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>299</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;558, 297&gt;</td>
    </tr>
    <tr>
      <td>300</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;543, 301&gt;</td>
    </tr>
    <tr>
      <td>301</td>
      <td>1095</td>
      <td>2</td>
      <td>Integer:752532121</td>
      <td>Boolean:False</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>301</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;528, 304&gt;</td>
    </tr>
    <tr>
      <td>302</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;517, 306&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>353</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;403, 215&gt;</td>
    </tr>
    <tr>
      <td>354</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;403, 215&gt;</td>
    </tr>
    <tr>
      <td>355</td>
      <td>1003</td>
      <td>2</td>
      <td>Boolean:True</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>355</td>
      <td>1001</td>
      <td>2</td>
      <td>Boolean:True</td>
      <td>ObjectId:468</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>355</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;403, 215&gt;</td>
    </tr>
    <tr>
      <td>356</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:13</td>
      <td>ScreenPosition:&lt;403, 215&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>399</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;265, 509&gt;</td>
    </tr>
    <tr>
      <td>400</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;265, 511&gt;</td>
    </tr>
    <tr>
      <td>401</td>
      <td>1095</td>
      <td>2</td>
      <td>Integer:1629276425</td>
      <td>Boolean:False</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>401</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;265, 511&gt;</td>
    </tr>
    <tr>
      <td>402</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;265, 511&gt;</td>
    </tr>
    <tr>
      <td>…</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>475</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;214, 493&gt;</td>
    </tr>
    <tr>
      <td>475</td>
      <td>1092</td>
      <td>2</td>
      <td>Position:&lt;443.9366, 1997.808, 0&gt;</td>
      <td>Float:0</td>
      <td>Float:0</td>
      <td>Float:1.278409</td>
      <td>Integer:2</td>
      <td>ScreenPosition:&lt;214, 493&gt;</td>
    </tr>
    <tr>
      <td>475</td>
      <td>27</td>
      <td>2</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Let’s try to figure out what each order type means:</p>

<ul>
  <li><code class="highlighter-rouge">1092</code>: It’s not obvious in the trimmed version, but this order type appears the most times, <em>by far</em>. We see it has 6 arguments: a 3D position, 3 floats, 1 integer, and 1 2D position. If you load the map we used in World Builder (the Generals editing tool), you’ll find that the 3D position in these orders corresponds with the map point at the centre of the screen. So it’s very likely that <code class="highlighter-rouge">1092</code> is some sort of <strong>set camera position</strong> order. It’s weird that Generals saves one of these for each timecode, even when the camera hasn’t moved; the replay file would be much smaller if it only saved this order when the camera moved. The non-zero float argument might be field-of-view, and I don’t yet know what the other arguments mean.</li>
  <li><code class="highlighter-rouge">1095</code>: This appears exactly every 100 timecodes. It has 1 integer and 1 boolean argument. Based on what I know about how RTS games do lockstep networking, and seeing that the integer argument value varies wildly, I guess this is a <strong>checksum</strong> order, which instructs the game engine to check that its internal world representation is in sync with other network players. In this case, there are no network players, but for simplicity the game engine probably runs this code anyway. Incidentally, it’s when this value doesn’t match the game’s computed state that you get the dreaded “game has detected a mismatch” error.
<img src="http://s27.postimg.org/53n0jh8kz/print_erro_generals.png" alt="" /></li>
  <li><code class="highlighter-rouge">1003</code>, immediately followed by <code class="highlighter-rouge">1001</code>: This timecode corresponds to when I selected the dozer. So <code class="highlighter-rouge">1003</code> is probably <strong>clear selection</strong>, and <code class="highlighter-rouge">1001</code> is probably <strong>set selection</strong>. <code class="highlighter-rouge">1001</code> has an <code class="highlighter-rouge">ObjectId</code> argument, which would be the ID of the object that should be selected. <a href="https://github.com/qibbi">Jana Mohn</a> helped me figure out that this is a runtime ID, with the index based on all the objects that have been loaded for the current map. As with many other aspects of replay files, only if the engine loads exactly the same things in exactly the same order, will it be able to successfully play a replay and get the same result.</li>
  <li><code class="highlighter-rouge">1049</code>: This has 1 integer, 1 3D position, and 1 float argument. The timecode corresponds to when I told the dozer to build a power plant, so this is probably a <strong>build object</strong> order. The integer argument is some kind of ID representing the object to build - and with experimentation, I have discovered that it’s an index into an array of all the <code class="highlighter-rouge">Object</code> definitions after they’ve been loaded from .ini files. The 3D position argument is where to build it, and the float argument is the angle at which to place the building.</li>
  <li><code class="highlighter-rouge">27</code>: This is always the last order in a replay file, so it’s some sort of <strong>end game</strong> order.</li>
</ul>

<p>And that’s it, for this simple replay file. Only 6 unique order types. Obviously in a full game, there would be many more order types, but this blog post is long enough already.</p>

<h2 id="in-action">In action</h2>

<p>As I mentioned at the beginning, my motivation for parsing Generals replay files is being to play them in OpenSAGE. So, I implemented just enough in OpenSAGE to be able to parse and “play” this simple replay file, and here is the result. It’s obviously extremely unfinished, but hopefully you can see the connection with the original replay. You can also see our work on the main menu, replay menu, map rendering, etc…</p>

<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/XNP_DfLrVQw" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>
</div>

<p>The code for “playing” a replay iterates through the chunks, with the appropriate timing, and executes each chunk’s order - for example, creating a building or setting the camera’s position. There’s a huge amount still to do. There are some mysteries that will have to be solved, such as the random number generator (RNG) used by Generals, so there are no guarantees that we’ll really be able to do it - but if I worried too much about that, I wouldn’t have started OpenSAGE in the first place. On the bright side, much of the code for running through a replay will carry over, as-is, to actually playing single-player and multi-player games.</p>

<h2 id="the-end">The end</h2>

<p>Hopefully that gives a rough picture of how one goes about parsing a binary file format where you know roughly what it should contain, but you don’t know the exact structure. Again, many thanks to louisdx for the <a href="https://github.com/louisdx/cnc-replayreaders">cnc-replayreaders project</a>. If I wasn’t able to build on that existing knowledge, this would have been a lot more difficult.</p>

<p>Parsing of Generals .rep replay files <a href="https://github.com/OpenSAGE/OpenSAGE/tree/master/src/OpenSage.Game/Data/Rep">is implemented in OpenSAGE here</a>. If you’re interested, you can browse the full code to see details I left out in this blog post.</p>

<p>If you’re interested in what we’re doing in OpenSAGE, <a href="https://discord.gg/G2FhZUT">join our Discord server</a> and chat to us, we’re quite friendly!</p>

</article>

<nav class="pagination">
  
    <a class="pagination-item" href="/blog/archive/2018/02/10/opensage-dev-diary-6-and-first-release">Previous</a>
  
  
    <a class="pagination-item" href="/blog/archive/2018/05/19/introducing-shader-playground">Next</a>
  
</nav>

<div id="disqus_thread"></div>
<script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://timjones.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="social">
    <ul>
        <li>
            <a href="https://twitter.com/_tim_jones_" rel="external">
                <svg width="30" height="30" viewBox="0 0 30 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">Twitter icon</title>
  <desc>A gray icon for following me on Twitter</desc>
  <path d="M28.928 7.296q-1.184 1.728-2.88 2.976 0 0.256 0 0.736 0 2.336-0.672 4.64t-2.048 4.448-3.296 3.744-4.608 2.624-5.792 0.96q-4.832 0-8.832-2.592 0.608 0.064 1.376 0.064 4.032 0 7.168-2.464-1.888-0.032-3.36-1.152t-2.048-2.848q0.608 0.096 1.088 0.096 0.768 0 1.536-0.192-2.016-0.416-3.328-1.984t-1.312-3.68v-0.064q1.216 0.672 2.624 0.736-1.184-0.8-1.888-2.048t-0.704-2.752q0-1.568 0.8-2.912 2.176 2.656 5.248 4.256t6.656 1.76q-0.16-0.672-0.16-1.312 0-2.4 1.696-4.064t4.064-1.696q2.528 0 4.224 1.824 1.952-0.384 3.68-1.408-0.672 2.048-2.56 3.2 1.664-0.192 3.328-0.896z"></path>
</svg>
                <span>Follow me on Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://github.com/tgjones" rel="external">
                <svg width="30" height="30" viewBox="0 0 27 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">GitHub icon</title>
  <desc>A gray icon for following me on GitHub</desc>
  <path d="M13.728 2.272q3.712 0 6.88 1.856t4.992 4.992 1.824 6.88q0 4.48-2.624 8.064t-6.752 4.96q-0.48 0.096-0.704-0.128t-0.224-0.544q0-0.032 0-1.376t0-2.4q0-1.728-0.928-2.528 1.024-0.096 1.824-0.32t1.696-0.704 1.44-1.184 0.96-1.856 0.352-2.688q0-2.144-1.408-3.68 0.672-1.632-0.128-3.648-0.512-0.16-1.472 0.192t-1.632 0.8l-0.672 0.416q-1.664-0.48-3.424-0.48t-3.456 0.48q-0.256-0.192-0.736-0.48t-1.504-0.704-1.504-0.224q-0.8 2.016-0.16 3.648-1.408 1.536-1.408 3.68 0 1.504 0.384 2.656t0.928 1.888 1.44 1.184 1.664 0.704 1.824 0.32q-0.672 0.64-0.864 1.856-0.384 0.16-0.8 0.256t-1.024 0.096-1.152-0.384-0.992-1.12q-0.352-0.576-0.864-0.928t-0.896-0.448l-0.352-0.032q-0.384 0-0.512 0.064t-0.096 0.224 0.16 0.256 0.224 0.192l0.128 0.096q0.384 0.192 0.768 0.672t0.576 0.928l0.192 0.416q0.224 0.672 0.768 1.088t1.184 0.544 1.248 0.096 0.992-0.032l0.416-0.096q0 0.704 0 1.6t0.032 0.96q0 0.32-0.256 0.544t-0.704 0.128q-4.128-1.376-6.752-4.96t-2.624-8.064q0-3.744 1.856-6.88t4.96-4.992 6.912-1.856zM5.184 21.984q0.064-0.128-0.096-0.224-0.192-0.032-0.256 0.032-0.032 0.128 0.128 0.224t0.224-0.032zM5.76 22.592q0.128-0.096-0.032-0.288-0.192-0.16-0.288-0.064-0.128 0.096 0.032 0.288t0.288 0.064zM6.272 23.392q0.192-0.128 0-0.352-0.128-0.224-0.288-0.096-0.16 0.096 0 0.32t0.288 0.128zM7.040 24.128q0.128-0.128-0.064-0.32-0.224-0.224-0.352-0.064-0.16 0.16 0.064 0.352 0.192 0.192 0.352 0.032zM8.064 24.576q0.032-0.192-0.256-0.288-0.256-0.064-0.32 0.128t0.224 0.288q0.256 0.096 0.352-0.128zM9.184 24.672q0-0.224-0.32-0.192-0.288 0-0.288 0.192 0 0.224 0.32 0.192 0.288 0 0.288-0.192zM10.208 24.512q-0.032-0.224-0.32-0.16-0.288 0.032-0.256 0.256t0.32 0.128 0.256-0.224z"></path>
</svg>        
                <span>Follow me on GitHub</span>
            </a>
        </li>
        <li>
            <a href="https://www.strava.com/athletes/timjones" rel="external">
                <?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="30px" height="30px" viewBox="0 0 244 244" enable-background="new 0 0 244 244" xml:space="preserve">
<g>
	<path fill="none" d="M122,242C55.8,242,2,188.2,2,122S55.8,2,122,2c66.2,0,120,53.8,120,120S188.2,242,122,242z M122,21.7
		c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"/>
	<path d="M122,21.7c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"
		/>
	<g>
		<polyline fill="#fff" points="139.4,184.3 112.3,131.1 128.4,131.1 139.4,152.6 150.2,131.1 166.3,131.1 139.4,184.3 		"/>
		<polygon fill="#fff" points="113.9,102.2 128.6,131.2 150.1,131.2 113.7,59.7 77.7,131.2 99.3,131.2 113.9,102.2 		"/>
	</g>
</g>
</svg>

                <span>Follow me on Strava</span>
            </a>
        </li>
    </ul>
</div>

            <p>© 2017 Tim Jones. All rights reserved.</p>
        </div>
    </footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5166698-5', 'auto');
  ga('send', 'pageview');
</script>
</body>

</html>