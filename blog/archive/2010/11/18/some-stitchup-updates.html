<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>Some StitchUp updates - timjones.io</title>

    <meta name="description" content="Blog and open source projects by Tim Jones.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="alternate" href="http://timjones.io/feed.xml" type="application/atom+xml" title="timjones.io Feed">

    <link href="https://fonts.googleapis.com/css?family=Noto+Sans|Noto+Serif|Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/site.css">

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true
            },
            showProcessingMessages: false
        });
    </script>
    <script type="text/javascript" async src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML.js"></script>
</head>

<body>
    <header class="masthead">
        <div class="container">
            <nav>
                <ul>
                    <li>
                        <h3><a href="/" class="site-title">Tim Jones</a></h3>
                    </li>
                    <li><a href="/projects/">Projects</a></li>
                    <li><a href="/about/">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <main>
            <article>
    <h1 class="post-title">Some StitchUp updates</h1>

    <div class="post-date">
        <time datetime="2010-11-18T22:45:00+00:00">18 November 2010</time>
    </div>

    

    <h2 id="the-short-version">The short version</h2>

<p>There is a new build of <a href="/blog/archive/2010/11/13/introducing-stitchup-generating-shaders-from-hlsl-shader-fragments">StitchUp</a> available <a href="https://github.com/tgjones/stitchup/downloads">here</a>.</p>

<p>It includes these new features:</p>
<ul>
  <li>The parser supports initial values for parameters.</li>
  <li>The parser supports C-style single line comments.</li>
  <li>The build output window in Visual Studio now shows a clickable message for the generated effect</li>
</ul>

<h2 id="the-long-version">The long version</h2>

<p>After my last post introducing <a href="/blog/archive/2010/11/13/introducing-stitchup-generating-shaders-from-hlsl-shader-fragments">StitchUp</a>, I received some feedback, including a very detailed comment from “Alejandro” (sorry Alejandro, I’m not implying I’m on first name terms with you, I just don’t know your surname). I started to reply to his comment, but it got quite big, so I thought I’d write a new post, which will allow me to wax more lyrical about some new features. I also think some of his questions might be interesting for a wider audience.</p>

<p>So, here are his questions, and my responses:</p>

<blockquote>
  <p>In the [params] body, how can I set a starting default value? like:
[params]
float4 color : DIFFUSE_COLOR; // = { 1,1,1,1}; ?</p>
</blockquote>

<p>It wasn’t possible before, but it is now. I’ve modified the parser to include support for initial values. So the following declarations are now possible - note that this is only valid within the <code class="highlighter-rouge">[params]</code> block, since they are the only variable declarations that initial values make sense on.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="n">params</span><span class="p">]</span>
<span class="n">float3</span> <span class="n">lightDir</span> <span class="o">:</span> <span class="n">LIGHT_DIRECTION</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
<span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
<span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre>
</div>

<p>Next question:</p>

<blockquote>
  <p>… the BasicMaterial fragment doesn’t import anything but has a [vertex] attribute and interpolator. Is there some magic wand going around behind the scenes? Like: “No one output-ed an uv and you need it, so I’ll just give to you”?.</p>
</blockquote>

<p>Yes, that is exactly what is happening. The code generator follows these rules:</p>

<ul>
  <li><em>If the fragment includes a vertex shader, then use it - don’t auto-generate one.</em> You might have values in the <code class="highlighter-rouge">[interpolators]</code> block that you want to pass to the pixel shader, but that is not going to happen automatically. You need to use the <code class="highlighter-rouge">output</code> meta-function, which is used by <code class="highlighter-rouge">PositionNormalTexture.fragment</code> in the demo project.</li>
  <li><em>If the fragment doesn’t include a vertex shader, then auto-generate one.</em> The code generator creates pass-through statements for all values in the <code class="highlighter-rouge">[interpolators]</code> block. For BasicMaterial, the auto-generated vertex shader looks like this:</li>
</ul>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">// -------- vertex shader basic_material2 --------
</span><span class="kt">void</span> <span class="nf">basic_material2_vs</span><span class="p">(</span><span class="n">basic_material2_VERTEXINPUT</span> <span class="n">input</span><span class="p">,</span> <span class="n">inout</span> <span class="n">VERTEXOUTPUT</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">output</span><span class="p">.</span><span class="n">basic_material2</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Next question:</p>

<blockquote>
  <p>Is it still possible to #include an .fxh with basic functions and methods? I tried but failed big time. Or the correct practice would be to think about “Helper Fragments” and you would be actually “importing the methods”? (for things like random, poisson things, etc).</p>
</blockquote>

<p>Yes, this is supported, in two ways.</p>

<ol>
  <li>You can create a fragment with only a <code class="highlighter-rouge">[headercode]</code> block. See <code class="highlighter-rouge">DirectionalLight.fragment</code> in the demo project for an example. I think this is the most elegant solution.</li>
  <li>You can use <code class="highlighter-rouge">#include</code> within an <code class="highlighter-rouge">__hlsl__</code> block, but because of the way I’m calling <code class="highlighter-rouge">EffectProcessor</code> with a dynamically generated effect, you’ll need to use absolute path names (i.e. <code class="highlighter-rouge">C:\...\MyInclude.fxh</code>).</li>
</ol>

<p>Next question:</p>

<blockquote>
  <p>Is there a way to see the stitched .fx file (ouput somewhere in some folder). I only see it when there is an error (usually name mismatch). Visual studio keeps it in a temporal folder.</p>
</blockquote>

<p>The output is always called <code class="highlighter-rouge">StitchedEffect.fx</code>, and it’s always saved in your temp folder. You’re right that Visual Studio only shows you a clickable error message if there’s an error. I’ve actually <a href="http://forums.create.msdn.com/forums/t/66862.aspx">asked on the App Hub forums</a> how to do this for informational messages. In the meantime, I have added a message to the build output log, which you can double-click on to open the stitched effect file. The message looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>C:\Users\Tim Jones\AppData\Local\Temp\StitchedEffect.fx :	Stitched effect generated (double-click this message to view).
</code></pre>
</div>

<p>Next question:</p>

<blockquote>
  <p>When assigning Visual C++ as the .fragment text editor (to get a little bit of syntax highlighting) commenting a line outside of the <strong>hlsl</strong> body (via ctrl+e, c) will always crash Visual Studio. (Is there a way to assign NShader as the syntax highlighter for the .fragment? that would be awesome)</p>
</blockquote>

<p>The first little issue is that the StitchUp parser didn’t allow for comments. I’ve implemented that now, so you can use C-style single-line comments in your <code class="highlighter-rouge">.fragment</code> files:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">float3</span> <span class="n">lightDir</span> <span class="o">:</span> <span class="n">LIGHT_DIRECTION</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span> <span class="c1">// This is a comment.
//float3 lightDir : LIGHT_DIRECTION = { 1.0f, -1, 1 };
</span></code></pre>
</div>

<p>I hadn’t heard of <a href="http://nshader.codeplex.com/">NShader</a> before - that’s a nice project. The only way I could see to add support for <code class="highlighter-rouge">.fragment</code> files was to change the original source code. Since the developers of NShader are unlikely to be interested in supporting StitchUp-specific extensions, I have <a href="https://github.com/tgjones/nshader-stitchup">created a fork of NShader</a>. You can <a href="https://github.com/tgjones/nshader-stitchup/downloads">download the StitchUp-specific VSIX file</a>. So far I have only added support for the <code class="highlighter-rouge">.fragment</code> extension, but it would be nice to add support for StitchUp keywords, such as <code class="highlighter-rouge">export</code>, <code class="highlighter-rouge">import</code> and <code class="highlighter-rouge">output</code>. Oh, and you probably don’t want to install it at the same time as the official NShader package - in any case, Visual Studio probably won’t let you, because I haven’t changed of the package GUIDs.</p>

<p>After installing this custom version of NShader, your <code class="highlighter-rouge">.fragment</code> files should look like this:</p>

<p><img src="/assets/posts/stitchup5.jpg" alt="" /></p>

<p>Hope this helps - as always, please post thoughts, feedback, etc. below.</p>

</article>

<nav class="pagination">
  
    <a class="pagination-item" href="/blog/archive/2010/11/16/terrain-geomipmapping-on-windows-phone">Previous</a>
  
  
    <a class="pagination-item" href="/blog/archive/2010/11/20/ds-obj-and-nff-content-importers-for-xna">Next</a>
  
</nav>

<div id="disqus_thread"></div>
<script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://timjones.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="social">
    <ul>
        <li>
            <a href="https://twitter.com/_tim_jones_" rel="external">
                <svg width="30" height="30" viewBox="0 0 30 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">Twitter icon</title>
  <desc>A gray icon for following me on Twitter</desc>
  <path d="M28.928 7.296q-1.184 1.728-2.88 2.976 0 0.256 0 0.736 0 2.336-0.672 4.64t-2.048 4.448-3.296 3.744-4.608 2.624-5.792 0.96q-4.832 0-8.832-2.592 0.608 0.064 1.376 0.064 4.032 0 7.168-2.464-1.888-0.032-3.36-1.152t-2.048-2.848q0.608 0.096 1.088 0.096 0.768 0 1.536-0.192-2.016-0.416-3.328-1.984t-1.312-3.68v-0.064q1.216 0.672 2.624 0.736-1.184-0.8-1.888-2.048t-0.704-2.752q0-1.568 0.8-2.912 2.176 2.656 5.248 4.256t6.656 1.76q-0.16-0.672-0.16-1.312 0-2.4 1.696-4.064t4.064-1.696q2.528 0 4.224 1.824 1.952-0.384 3.68-1.408-0.672 2.048-2.56 3.2 1.664-0.192 3.328-0.896z"></path>
</svg>
                <span>Follow me on Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://github.com/tgjones" rel="external">
                <svg width="30" height="30" viewBox="0 0 27 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">GitHub icon</title>
  <desc>A gray icon for following me on GitHub</desc>
  <path d="M13.728 2.272q3.712 0 6.88 1.856t4.992 4.992 1.824 6.88q0 4.48-2.624 8.064t-6.752 4.96q-0.48 0.096-0.704-0.128t-0.224-0.544q0-0.032 0-1.376t0-2.4q0-1.728-0.928-2.528 1.024-0.096 1.824-0.32t1.696-0.704 1.44-1.184 0.96-1.856 0.352-2.688q0-2.144-1.408-3.68 0.672-1.632-0.128-3.648-0.512-0.16-1.472 0.192t-1.632 0.8l-0.672 0.416q-1.664-0.48-3.424-0.48t-3.456 0.48q-0.256-0.192-0.736-0.48t-1.504-0.704-1.504-0.224q-0.8 2.016-0.16 3.648-1.408 1.536-1.408 3.68 0 1.504 0.384 2.656t0.928 1.888 1.44 1.184 1.664 0.704 1.824 0.32q-0.672 0.64-0.864 1.856-0.384 0.16-0.8 0.256t-1.024 0.096-1.152-0.384-0.992-1.12q-0.352-0.576-0.864-0.928t-0.896-0.448l-0.352-0.032q-0.384 0-0.512 0.064t-0.096 0.224 0.16 0.256 0.224 0.192l0.128 0.096q0.384 0.192 0.768 0.672t0.576 0.928l0.192 0.416q0.224 0.672 0.768 1.088t1.184 0.544 1.248 0.096 0.992-0.032l0.416-0.096q0 0.704 0 1.6t0.032 0.96q0 0.32-0.256 0.544t-0.704 0.128q-4.128-1.376-6.752-4.96t-2.624-8.064q0-3.744 1.856-6.88t4.96-4.992 6.912-1.856zM5.184 21.984q0.064-0.128-0.096-0.224-0.192-0.032-0.256 0.032-0.032 0.128 0.128 0.224t0.224-0.032zM5.76 22.592q0.128-0.096-0.032-0.288-0.192-0.16-0.288-0.064-0.128 0.096 0.032 0.288t0.288 0.064zM6.272 23.392q0.192-0.128 0-0.352-0.128-0.224-0.288-0.096-0.16 0.096 0 0.32t0.288 0.128zM7.040 24.128q0.128-0.128-0.064-0.32-0.224-0.224-0.352-0.064-0.16 0.16 0.064 0.352 0.192 0.192 0.352 0.032zM8.064 24.576q0.032-0.192-0.256-0.288-0.256-0.064-0.32 0.128t0.224 0.288q0.256 0.096 0.352-0.128zM9.184 24.672q0-0.224-0.32-0.192-0.288 0-0.288 0.192 0 0.224 0.32 0.192 0.288 0 0.288-0.192zM10.208 24.512q-0.032-0.224-0.32-0.16-0.288 0.032-0.256 0.256t0.32 0.128 0.256-0.224z"></path>
</svg>        
                <span>Follow me on GitHub</span>
            </a>
        </li>
        <li>
            <a href="https://www.strava.com/athletes/timjones" rel="external">
                <?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="30px" height="30px" viewBox="0 0 244 244" enable-background="new 0 0 244 244" xml:space="preserve">
<g>
	<path fill="none" d="M122,242C55.8,242,2,188.2,2,122S55.8,2,122,2c66.2,0,120,53.8,120,120S188.2,242,122,242z M122,21.7
		c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"/>
	<path d="M122,21.7c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"
		/>
	<g>
		<polyline fill="#fff" points="139.4,184.3 112.3,131.1 128.4,131.1 139.4,152.6 150.2,131.1 166.3,131.1 139.4,184.3 		"/>
		<polygon fill="#fff" points="113.9,102.2 128.6,131.2 150.1,131.2 113.7,59.7 77.7,131.2 99.3,131.2 113.9,102.2 		"/>
	</g>
</g>
</svg>

                <span>Follow me on Strava</span>
            </a>
        </li>
    </ul>
</div>

            <p>© 2017 Tim Jones. All rights reserved.</p>
        </div>
    </footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5166698-5', 'auto');
  ga('send', 'pageview');
</script>
</body>

</html>