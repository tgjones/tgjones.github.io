<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>Cascaded shadow maps sample for MonoGame - timjones.io</title>

    <meta name="description" content="Blog and open source projects by Tim Jones.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="alternate" href="http://timjones.io/feed.xml" type="application/atom+xml" title="timjones.io Feed">

    <link href="https://fonts.googleapis.com/css?family=Noto+Sans|Noto+Serif|Source+Code+Pro" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/site.css">

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                processEscapes: true
            },
            showProcessingMessages: false
        });
    </script>
    <script type="text/javascript" async src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML.js"></script>
</head>

<body>
    <header class="masthead">
        <div class="container">
            <nav>
                <ul>
                    <li>
                        <h3><a href="/" class="site-title">Tim Jones</a></h3>
                    </li>
                    <li><a href="/projects/">Projects</a></li>
                    <li><a href="/about/">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <main>
            <article>
    <h1 class="post-title">Cascaded shadow maps sample for MonoGame</h1>

    <div class="post-date">
        <time datetime="2015-04-13T16:25:00+00:00">13 April 2015</time>
    </div>

    

    <h2 id="tldr">TL/DR</h2>

<p>The source code for this sample is on GitHub, <strong>but see the note in the next paragraph</strong>.</p>

<ul>
  <li><a href="https://github.com/tgjones/monogame-samples/tree/master/CascadedShadowMaps">Cascaded shadow maps sample for MonoGame - source code</a></li>
</ul>

<p><em>Because this sample uses features that were added very recently to MonoGame (since v3.3), <strong>you’ll need to install a development build of MonoGame if you want to try it out</strong>. Go to the <a href="http://www.monogame.net/downloads/">MonoGame downloads page</a>, and under the “Development Builds” heading, download the “MonoGame for Visual Studio” installer. (Of course, if you’re reading this after v3.4 is released, then ignore this paragraph.)</em></p>

<h2 id="the-details">The details</h2>

<p>This is a sample I’ve been working on for MonoGame, demonstrating <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ee416307%28v=vs.85%29.aspx">cascaded shadow maps</a>. Cascaded shadow maps are great for rendering outdoor scenes, such as large terrains. Cascaded shadow maps are a variant of traditional shadow mapping, where you divide up the rendered scene into 2 or more parts, at increasing distances from the camera. The closest cascade is the highest quality, but only covers a small area, and the farthest cascade is the lowest quality, and covers a large area.</p>

<p>Cascaded shadow maps were first written about in 2007 (at least, Wolfgang Engel’s article in ShaderX5 was the first to use that term, I believe). Since then, the basic algorithm has been improved in a number of ways. This sample includes several of those improvements - such as stabilisation, optimised PCF filtering, and normal offset in addition to a basic depth bias.</p>

<p>It is essentially a port of <a href="https://mynameismjp.wordpress.com/2013/09/10/shadow-maps/">MJP’s shadows sample</a>. He did all the hard work! Go read that blog post for much more detail about the techniques demonstrated here.</p>

<p>Here are a couple of screenshots, the first showing just the shadows, and the second showing the cascades in different colours. The closest cascade is red, but isn’t visible in this screenshot.</p>

<p><img src="/assets/posts/shadow-mapping-1.png" alt="" /></p>

<p><img src="/assets/posts/shadow-mapping-2.png" alt="" /></p>

<p>The only filtering option I have implemented is <a href="http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/">the PCF technique used in The Witness</a>. This technique looks pretty good, especially compared to other techniques that use a similar number of shader instructions. In the sample, you can toggle the filter size using <code class="highlighter-rouge">f</code>, from 2x2 all the way up to 7x7.</p>

<p>The sample allows you to play with both depth bias (little <code class="highlighter-rouge">b</code> to decrement, capital <code class="highlighter-rouge">B</code> to increment) and <a href="http://www.dissidentlogic.com/old/">normal offset</a> (little <code class="highlighter-rouge">o</code>, capital <code class="highlighter-rouge">O</code>), so you can easily see the effect these have.</p>

<p>You can visualise the cascades with the <code class="highlighter-rouge">v</code> key, enable filtering across cascades with <code class="highlighter-rouge">k</code>, and stabilise cascades with <code class="highlighter-rouge">c</code>. Stabilising the cascades means that shadows won’t shimmer as you move and rotate the camera. You do lose some quality by doing that, but the trade-off is usually worth it.</p>

<p>Hold the right mouse button to look around, and use the standard WASD keys to move around.</p>

<h2 id="standing-on-the-shoulders-of-giants">Standing on the shoulders of giants</h2>

<p>Graphics APIs (Direct3D, OpenGL) have evolved in the last few years to include optimisations either specifically intended for shadow maps, or directly applicable to shadow maps. These optimisations are commonly used in games nowadays, but those of us using XNA didn’t have access to them. The beauty of open source is that with MonoGame, we can fix that. I wanted to make this sample as up-to-date as possible, so while I was working on this shadow mapping sample, I submitted a few pull requests to MonoGame. Fortunately they were accepted, and so these features are both used in this sample, and are now a part of MonoGame:</p>

<ul>
  <li>
    <p><a href="https://github.com/mono/MonoGame/pull/3628">Comparison samplers</a> - graphics hardware has supported hardware PCF filtering for a while now. In Direct3D, this feature was exposed through comparison samplers. XNA didn’t support them, but MonoGame now does. (Unfortunately both this feature, and texture arrays, only work for Direct3D at the moment. That’s because MojoShader, which MonoGame uses to translate HLSL shaders into GLSL, can’t cope with comparison samplers or texture arrays. Hopefully that will be fixed soon. But right now, this limitation means that this sample only works for Direct3D on Windows.)</p>
  </li>
  <li>
    <p><a href="https://github.com/mono/MonoGame/pull/3654">Texture arrays</a> - cascaded shadow maps are normally rendered using 4 cascades, where each cascade is a separate shadow map. In XNA, you could either render these as 4 separate textures (slower, but simpler), or fit them all into 1 texture and manage the offset and scaling yourself (faster, but more complex). Texture arrays give you the best of both.</p>
  </li>
  <li>
    <p><a href="https://github.com/mono/MonoGame/pull/3706">Depth clamping</a> - disables clipping to the near and far planes. Without this, you have to back up the shadow caster camera the right distance so that you don’t clip any of the scene behind the near plane or beyond the far plane. With depth clamping, you don’t need to do that calculation.</p>
  </li>
</ul>

<p>I’m publishing this sample in the hope that it’s useful to others. Some of the code is a bit tricky to get right, so if you want to add cascaded shadow maps to your game, hopefully this will help you get started. Feel free to ask questions in the comments below.</p>

<p>In case anyone’s wondering what happened to the game engine I <a href="https://twitter.com/roastedamoeba/status/569886323462447104">teased</a> on Twitter a couple of months ago - it’s coming! But I found that a few components - in particular, shadows and terrain - were quite difficult to get working robustly. So I’m breaking them out into little sample apps, this one being the first, as a way to help me figure things out.</p>

</article>

<nav class="pagination">
  
    <a class="pagination-item" href="/blog/archive/2014/12/28/make-santa-jump-game-in-fsharp-using-monogame">Previous</a>
  
  
    <a class="pagination-item" href="/blog/archive/2015/09/02/parsing-direct3d-shader-bytecode">Next</a>
  
</nav>

<div id="disqus_thread"></div>
<script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://timjones.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="social">
    <ul>
        <li>
            <a href="https://twitter.com/_tim_jones_" rel="external">
                <svg width="30" height="30" viewBox="0 0 30 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">Twitter icon</title>
  <desc>A gray icon for following me on Twitter</desc>
  <path d="M28.928 7.296q-1.184 1.728-2.88 2.976 0 0.256 0 0.736 0 2.336-0.672 4.64t-2.048 4.448-3.296 3.744-4.608 2.624-5.792 0.96q-4.832 0-8.832-2.592 0.608 0.064 1.376 0.064 4.032 0 7.168-2.464-1.888-0.032-3.36-1.152t-2.048-2.848q0.608 0.096 1.088 0.096 0.768 0 1.536-0.192-2.016-0.416-3.328-1.984t-1.312-3.68v-0.064q1.216 0.672 2.624 0.736-1.184-0.8-1.888-2.048t-0.704-2.752q0-1.568 0.8-2.912 2.176 2.656 5.248 4.256t6.656 1.76q-0.16-0.672-0.16-1.312 0-2.4 1.696-4.064t4.064-1.696q2.528 0 4.224 1.824 1.952-0.384 3.68-1.408-0.672 2.048-2.56 3.2 1.664-0.192 3.328-0.896z"></path>
</svg>
                <span>Follow me on Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://github.com/tgjones" rel="external">
                <svg width="30" height="30" viewBox="0 0 27 32" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title">
  <title id="title">GitHub icon</title>
  <desc>A gray icon for following me on GitHub</desc>
  <path d="M13.728 2.272q3.712 0 6.88 1.856t4.992 4.992 1.824 6.88q0 4.48-2.624 8.064t-6.752 4.96q-0.48 0.096-0.704-0.128t-0.224-0.544q0-0.032 0-1.376t0-2.4q0-1.728-0.928-2.528 1.024-0.096 1.824-0.32t1.696-0.704 1.44-1.184 0.96-1.856 0.352-2.688q0-2.144-1.408-3.68 0.672-1.632-0.128-3.648-0.512-0.16-1.472 0.192t-1.632 0.8l-0.672 0.416q-1.664-0.48-3.424-0.48t-3.456 0.48q-0.256-0.192-0.736-0.48t-1.504-0.704-1.504-0.224q-0.8 2.016-0.16 3.648-1.408 1.536-1.408 3.68 0 1.504 0.384 2.656t0.928 1.888 1.44 1.184 1.664 0.704 1.824 0.32q-0.672 0.64-0.864 1.856-0.384 0.16-0.8 0.256t-1.024 0.096-1.152-0.384-0.992-1.12q-0.352-0.576-0.864-0.928t-0.896-0.448l-0.352-0.032q-0.384 0-0.512 0.064t-0.096 0.224 0.16 0.256 0.224 0.192l0.128 0.096q0.384 0.192 0.768 0.672t0.576 0.928l0.192 0.416q0.224 0.672 0.768 1.088t1.184 0.544 1.248 0.096 0.992-0.032l0.416-0.096q0 0.704 0 1.6t0.032 0.96q0 0.32-0.256 0.544t-0.704 0.128q-4.128-1.376-6.752-4.96t-2.624-8.064q0-3.744 1.856-6.88t4.96-4.992 6.912-1.856zM5.184 21.984q0.064-0.128-0.096-0.224-0.192-0.032-0.256 0.032-0.032 0.128 0.128 0.224t0.224-0.032zM5.76 22.592q0.128-0.096-0.032-0.288-0.192-0.16-0.288-0.064-0.128 0.096 0.032 0.288t0.288 0.064zM6.272 23.392q0.192-0.128 0-0.352-0.128-0.224-0.288-0.096-0.16 0.096 0 0.32t0.288 0.128zM7.040 24.128q0.128-0.128-0.064-0.32-0.224-0.224-0.352-0.064-0.16 0.16 0.064 0.352 0.192 0.192 0.352 0.032zM8.064 24.576q0.032-0.192-0.256-0.288-0.256-0.064-0.32 0.128t0.224 0.288q0.256 0.096 0.352-0.128zM9.184 24.672q0-0.224-0.32-0.192-0.288 0-0.288 0.192 0 0.224 0.32 0.192 0.288 0 0.288-0.192zM10.208 24.512q-0.032-0.224-0.32-0.16-0.288 0.032-0.256 0.256t0.32 0.128 0.256-0.224z"></path>
</svg>        
                <span>Follow me on GitHub</span>
            </a>
        </li>
        <li>
            <a href="https://www.strava.com/athletes/timjones" rel="external">
                <?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="30px" height="30px" viewBox="0 0 244 244" enable-background="new 0 0 244 244" xml:space="preserve">
<g>
	<path fill="none" d="M122,242C55.8,242,2,188.2,2,122S55.8,2,122,2c66.2,0,120,53.8,120,120S188.2,242,122,242z M122,21.7
		c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"/>
	<path d="M122,21.7c-55.3,0-100.3,45-100.3,100.3s45,100.3,100.3,100.3s100.3-45,100.3-100.3S177.3,21.7,122,21.7z"
		/>
	<g>
		<polyline fill="#fff" points="139.4,184.3 112.3,131.1 128.4,131.1 139.4,152.6 150.2,131.1 166.3,131.1 139.4,184.3 		"/>
		<polygon fill="#fff" points="113.9,102.2 128.6,131.2 150.1,131.2 113.7,59.7 77.7,131.2 99.3,131.2 113.9,102.2 		"/>
	</g>
</g>
</svg>

                <span>Follow me on Strava</span>
            </a>
        </li>
    </ul>
</div>

            <p>© 2017 Tim Jones. All rights reserved.</p>
        </div>
    </footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5166698-5', 'auto');
  ga('send', 'pageview');
</script>
</body>

</html>